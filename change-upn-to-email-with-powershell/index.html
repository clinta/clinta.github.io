<!doctype html><html lang=en-us><head><meta charset=utf-8><title></title><meta name=author content="Clint Armstrong"><meta name=description content><meta name=viewport content="width=device-width,initial-scale=1"><link rel=icon href=/favicon.png><link rel=apple-touch-icon-precomposed href=/apple-touch-icon.png><link rel=stylesheet href=/style.css><script type=application/javascript>var doNotTrack=false;if(!doNotTrack){(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');ga('create','UA-58778705-1','auto');ga('send','pageview');}</script></head><body><div class="header center noPrint"><ul class=navbar><li class=navbar><a class=navbar href=/>Posts</a></li><li class=navbar><a class=navbar href=https://twitter.com/clinta>Twitter</a></li><li class=navbar><a class=navbar href=/resume/>Resume</a></li></ul></div><div class=wrap><main><article class=post><h1 class=title><a href=https://clinta.github.io/change-upn-to-email-with-powershell/ title="Changing UPN to Email with Powershell">Changing UPN to Email with Powershell</a></h1><p>If you need a quick way to change the UPN of all your users in active directory to match their email address, PowerShell makes it easy.</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-powershell data-lang=powershell>$users = get-aduser -SearchBase <span style=color:#e6db74>&#34;OU=Users,DC=ad,DC=contoso,DC=com&#34;</span> -Filter * -Properties EmailAddress |
where {$_.EmailAddress <span style=color:#f92672>-ne</span> $null <span style=color:#f92672>-AND</span> $_.EmailAddress.toLower() <span style=color:#f92672>-ne</span> $_.UserPrincipalName.toLower()}

<span style=color:#66d9ef>foreach</span> ($user <span style=color:#66d9ef>in</span> $users) {
    $forest = Get-ADForest
    $email = $user.EmailAddress
    $username = $email.toLower().Split(<span style=color:#e6db74>&#39;@&#39;</span>)[0]
    $userdomain = $email.toLower().Split(<span style=color:#e6db74>&#39;@&#39;</span>)[1]
    <span style=color:#66d9ef>if</span> (<span style=color:#f92672>-Not</span> $($forest.UPNSuffixes).Contains($userdomain)) {
        $forest | Set-ADForest -UPNSuffixes @{Add=<span style=color:#e6db74>&#34;$userdomain&#34;</span>}
    }
    $user | Set-ADUser -UserPrincipalName <span style=color:#e6db74>&#34;$username@$userdomain&#34;</span>
}
</code></pre></div><p class="small gray pubDate"><time datetime=2015-08-07>2015-08-07</time></p></article></main></div></body></html>